From 5422dc0e6815d528111cf0de77d0abe91a04f5f1 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Marco=20Trevisan=20=28Trevi=C3=B1o=29?= <mail@3v1n0.net>
Date: Fri, 2 Feb 2018 02:10:59 +0100
Subject: [PATCH] linux: add support unity launcher when snapped

---
 .../platform/linux/main_window_linux.cpp           | 23 ++++++++++++++++------
 1 file changed, 17 insertions(+), 6 deletions(-)

diff --git a/Telegram/SourceFiles/platform/linux/main_window_linux.cpp b/Telegram/SourceFiles/platform/linux/main_window_linux.cpp
index 2e93c51..f537e9a 100644
--- a/Telegram/SourceFiles/platform/linux/main_window_linux.cpp
+++ b/Telegram/SourceFiles/platform/linux/main_window_linux.cpp
@@ -540,16 +540,27 @@ void MainWindow::psFirstShow() {
 
 #if !defined(TDESKTOP_DISABLE_GTK_INTEGRATION) && !defined(TDESKTOP_DISABLE_UNITY_INTEGRATION)
 	if (useUnityCount) {
-		_psUnityLauncherEntry = Libs::unity_launcher_entry_get_for_desktop_id("telegramdesktop.desktop");
-		if (_psUnityLauncherEntry) {
-			LOG(("Found Unity Launcher entry telegramdesktop.desktop!"));
-		} else {
-			_psUnityLauncherEntry = Libs::unity_launcher_entry_get_for_desktop_id("Telegram.desktop");
+		auto snapName = QString::fromLatin1(qgetenv("SNAP_NAME"));
+		if (!snapName.isEmpty()) {
+			QString snapDesktopId = snapName + qsl("_") + snapName + qsl(".desktop");
+			_psUnityLauncherEntry = Libs::unity_launcher_entry_get_for_desktop_id(snapDesktopId.toLatin1().data());
 			if (_psUnityLauncherEntry) {
-				LOG(("Found Unity Launcher entry Telegram.desktop!"));
+				LOG(("Found Unity Launcher entry telegram-desktop_telegram-desktop.desktop!"));
 			} else {
 				LOG(("Could not get Unity Launcher entry!"));
 			}
+		} else {
+			_psUnityLauncherEntry = Libs::unity_launcher_entry_get_for_desktop_id("telegramdesktop.desktop");
+			if (_psUnityLauncherEntry) {
+				LOG(("Found Unity Launcher entry telegramdesktop.desktop!"));
+			} else {
+				_psUnityLauncherEntry = Libs::unity_launcher_entry_get_for_desktop_id("Telegram.desktop");
+				if (_psUnityLauncherEntry) {
+					LOG(("Found Unity Launcher entry Telegram.desktop!"));
+				} else {
+					LOG(("Could not get Unity Launcher entry!"));
+				}
+			}
 		}
 	} else {
 		LOG(("Not using Unity Launcher count."));
-- 
2.7.4

